import{r as i,j as e,H as Se,a as se}from"./app-DqdLS_po.js";import{l as Fe,S as M,h as qe}from"./SaleController-CWOAsHby.js";import{A as ze,B as Re,aJ as Te}from"./app-layout-BY_z2l7K.js";import{B as u}from"./badge-DSvvMiB9.js";import{B as c}from"./button-DVQP8ugw.js";import{e as te,d as ae,a as ne,D as re,b as Pe,c as Le}from"./dialog-DIwoh3XE.js";import{I as p}from"./input-CikxobFJ.js";import{L as v}from"./label-CKEEuidP.js";import{c as B,a as E,b as $,S as O,d as f}from"./select-HYGYj5Xd.js";import{S as K}from"./separator-DGAiZpJH.js";import{U as ie}from"./user-DJ3XHO1Z.js";import{X as le}from"./x-C_vLIVyO.js";import{S as Ae}from"./search-Ezxgfz2g.js";import{S as De}from"./scan-barcode-CkQBUiwX.js";import{P as ke}from"./index-CxeexwSe.js";import{T as Me}from"./triangle-alert-C1kSQOGD.js";import{M as Be}from"./minus-Ba6e_v4s.js";import{P as V}from"./plus-fUC_Frcj.js";import{T as Ee}from"./trash-2-BLXb_zlu.js";/* empty css            */import"./index-CJ7mWlm-.js";import"./index-CSEUMRIG.js";import"./index-oTu_XNBi.js";import"./Combination-CjQPbJWN.js";import"./index-BY9hahA7.js";import"./index-CHdNXJ1h.js";import"./index-B_e8Ugpt.js";import"./app-logo-icon-BquCEMUK.js";import"./building-2-q9KNC_Mq.js";import"./warehouse-CXlB-vPY.js";import"./store-B14O_uPo.js";import"./square-user-BhCGZFIc.js";import"./truck-D0hplmIV.js";import"./index-CQuKHLBU.js";import"./check-CFlOe0yf.js";function vs({session:U,shopStocks:j,promotions:y,customers:oe,paymentMethods:ce}){const[l,m]=i.useState([]),[b,de]=i.useState(""),[ue,C]=i.useState(!1),[me,w]=i.useState(!1),[S,F]=i.useState(null),[x,h]=i.useState([{method:"cash",amount:0,reference:""}]),[g,T]=i.useState(0),[P,xe]=i.useState("return"),[H,X]=i.useState(!1),[q,G]=i.useState(""),[J,Q]=i.useState("");i.useRef(null);const N=i.useRef(""),d=i.useRef(null),W=i.useMemo(()=>{if(!b)return j;const s=b.toLowerCase();return j.filter(t=>t.product.name.toLowerCase().includes(s)||t.product.code.toLowerCase().includes(s)||(t.product.category?.name??"").toLowerCase().includes(s))},[j,b]),Y=i.useMemo(()=>l.reduce((s,t)=>s+t.unit_price*t.quantity,0),[l]),L=i.useMemo(()=>l.reduce((s,t)=>s+t.discount,0),[l]),o=Y-L,z=i.useMemo(()=>x.reduce((s,t)=>s+t.amount,0),[x]),A=Math.max(0,o-z),D=Math.max(0,z-o),Z=i.useCallback(s=>y.filter(t=>t.is_active&&(t.products.length===0||t.products.some(n=>n.id===s))),[y]),R=i.useCallback((s,t,n)=>{if(!n)return 0;const a=y.find(r=>r.id===n);return a?a.type==="percentage"?Math.round(s*(Number(a.value)/100)*t*100)/100:Math.min(Number(a.value),s)*t:0},[y]),I=i.useCallback(async s=>{const t=j.find(n=>n.product.code.toLowerCase()===s.toLowerCase());if(t){_(t);return}try{const n=await fetch(`${Fe().url}?barcode=${encodeURIComponent(s)}`,{headers:{Accept:"application/json"}});if(n.ok){const a=await n.json();if(a.product){const r={product:a.product,available_quantity:a.available_quantity,stock_alert:0,is_low_stock:a.is_low_stock};_(r)}}}catch{}},[j]);i.useEffect(()=>{function s(t){const n=t.target;if(!(n.tagName==="TEXTAREA"||n.tagName==="INPUT"&&!n.classList.contains("barcode-scanner-input"))){if(t.key==="Enter"){N.current.length>3&&(t.preventDefault(),I(N.current)),N.current="",d.current&&clearTimeout(d.current);return}t.key.length===1&&!t.ctrlKey&&!t.metaKey&&!t.altKey&&(N.current+=t.key,d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{N.current=""},80))}}return window.addEventListener("keydown",s),()=>{window.removeEventListener("keydown",s),d.current&&clearTimeout(d.current)}},[I]);function _(s){m(t=>{const n=t.find(r=>r.product.id===s.product.id);if(n)return n.quantity>=s.available_quantity?t:t.map(r=>r.product.id===s.product.id?{...r,quantity:r.quantity+1,discount:R(r.unit_price,r.quantity+1,r.promotion_id)}:r);const a=Number(s.product.price);return[...t,{product:s.product,quantity:1,unit_price:a,discount:0,promotion_id:null,available_quantity:s.available_quantity}]})}function he(s){m(t=>{const n=t.find(r=>r.product.id===s.product.id);if(n)return n.quantity>=s.available_quantity?t:t.map(r=>r.product.id===s.product.id?{...r,quantity:r.quantity+1,discount:R(r.unit_price,r.quantity+1,r.promotion_id)}:r);const a=Number(s.product.price);return[...t,{product:s.product,quantity:1,unit_price:a,discount:0,promotion_id:null,available_quantity:s.available_quantity}]})}function ee(s,t){m(n=>n.map(a=>{if(a.product.id!==s)return a;const r=a.quantity+t;return r<=0?null:r>a.available_quantity?a:{...a,quantity:r,discount:R(a.unit_price,r,a.promotion_id)}}).filter(Boolean))}function pe(s){m(t=>t.filter(n=>n.product.id!==s))}function fe(s,t){m(n=>n.map(a=>a.product.id!==s?a:{...a,promotion_id:t,discount:R(a.unit_price,a.quantity,t)}))}function je(){h(s=>[...s,{method:"cash",amount:0,reference:""}])}function k(s,t,n){h(a=>a.map((r,we)=>we===s?{...r,[t]:n}:r))}function ge(s){h(t=>t.filter((n,a)=>a!==s))}function Ne(){h([{method:"cash",amount:o,reference:""}]),T(o)}function ve(){l.length!==0&&(C(!0),h([{method:"cash",amount:o,reference:""}]),T(o))}function ye(){X(!0);const s={items:l.map(t=>({product_id:t.product.id,quantity:t.quantity,promotion_id:t.promotion_id})),payments:x.filter(t=>t.amount>0).map(t=>({method:t.method,amount:t.amount,reference:t.reference||null,notes:null})),customer_id:S?.id??null,amount_given:g,change_action:P==="credit_customer"?"credit_customer":P==="keep_residue"?"keep_residue":null,notes:null};se.post(qe().url,s,{onFinish:()=>{X(!1),C(!1)},onSuccess:()=>{m([]),h([{method:"cash",amount:0,reference:""}]),F(null)}})}function be(){q&&fetch(Te().url,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||"",Accept:"application/json"},body:JSON.stringify({name:q,phone:J||null})}).then(s=>s.json()).then(s=>{F(s.customer),w(!1),G(""),Q("")})}const Ce=[{title:"Dashboard",href:"/dashboard"},{title:"Point de vente",href:"/pos"},{title:"Terminal",href:"#"}];return e.jsxs(ze,{breadcrumbs:Ce,children:[e.jsx(Se,{title:"Terminal de vente"}),e.jsxs("div",{className:"flex h-full flex-1 flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between border-b bg-card px-4 py-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(M,{className:"size-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"POS"}),e.jsx(u,{variant:"outline",children:U.shop.name}),e.jsxs(u,{variant:"secondary",children:["#",U.session_number]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[S?e.jsxs(u,{variant:"default",className:"flex items-center gap-1",children:[e.jsx(ie,{className:"size-3"}),S.name,e.jsx("button",{onClick:()=>F(null),className:"ml-1",children:e.jsx(le,{className:"size-3"})})]}):e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>w(!0),children:[e.jsx(ie,{className:"size-4"}),"Client"]}),e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>se.visit("/pos"),children:"Retour"})]})]}),e.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex flex-1 flex-col overflow-hidden border-r",children:[e.jsx("div",{className:"border-b p-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ae,{className:"absolute left-3 top-1/2 size-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(p,{placeholder:"Rechercher un produit (nom, code, code-barres, catégorie)...",className:"pl-10",value:b,onChange:s=>de(s.target.value),autoFocus:!0})]}),e.jsxs("div",{className:"flex items-center gap-1.5 rounded-md border border-dashed px-2.5 text-xs text-muted-foreground",children:[e.jsx(De,{className:"size-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Scanner actif"})]})]})}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:W.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center gap-2 py-20 text-center",children:[e.jsx(ke,{className:"size-12 text-muted-foreground/40"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun produit trouvé"})]}):e.jsx("div",{className:"grid gap-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:W.map(s=>{const t=l.find(a=>a.product.id===s.product.id),n=Z(s.product.id);return e.jsxs("button",{onClick:()=>he(s),disabled:t&&t.quantity>=s.available_quantity,className:`group relative flex flex-col rounded-lg border p-3 text-left transition-all hover:border-primary hover:shadow-sm ${t?"border-primary bg-primary/5":""} ${s.is_low_stock?"border-orange-300":""}`,children:[t&&e.jsx(u,{className:"absolute -right-1 -top-1 size-6 items-center justify-center rounded-full p-0 text-xs",children:t.quantity}),n.length>0&&e.jsx(u,{variant:"destructive",className:"absolute left-1 top-1 text-[9px]",children:"Promo"}),e.jsx("span",{className:"truncate text-sm font-medium",children:s.product.name}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.product.code}),e.jsxs("div",{className:"mt-auto flex items-end justify-between pt-2",children:[e.jsx("span",{className:"text-sm font-bold text-primary",children:Number(s.product.price).toLocaleString("fr-FR")}),e.jsxs("span",{className:`text-xs ${s.is_low_stock?"font-medium text-orange-600":"text-muted-foreground"}`,children:[s.available_quantity," dispo",s.is_low_stock&&e.jsx(Me,{className:"ml-0.5 inline size-3"})]})]})]},s.product.id)})})})]}),e.jsxs("div",{className:"flex w-[400px] flex-col bg-card",children:[e.jsx("div",{className:"border-b p-3",children:e.jsxs("h2",{className:"flex items-center gap-2 font-semibold",children:[e.jsx(M,{className:"size-4"}),"Panier",l.length>0&&e.jsxs(u,{variant:"secondary",className:"text-xs",children:[l.reduce((s,t)=>s+t.quantity,0)," article",l.length>1?"s":""]})]})}),e.jsx("div",{className:"flex-1 overflow-auto p-2",children:l.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center gap-2 py-10 text-muted-foreground",children:[e.jsx(M,{className:"size-8 opacity-30"}),e.jsx("p",{className:"text-sm",children:"Panier vide"}),e.jsx("p",{className:"text-xs",children:"Cliquez sur un produit pour l'ajouter"})]}):e.jsx("div",{className:"space-y-1",children:l.map(s=>{const t=s.unit_price*s.quantity-s.discount,n=Z(s.product.id);return e.jsxs("div",{className:"rounded-lg border p-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-medium",children:s.product.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.unit_price.toLocaleString("fr-FR")," × ",s.quantity]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm font-bold",children:t.toLocaleString("fr-FR")}),s.discount>0&&e.jsxs("p",{className:"text-xs text-green-600",children:["-",s.discount.toLocaleString("fr-FR")]})]})]}),e.jsxs("div",{className:"mt-1 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(c,{variant:"outline",size:"icon",className:"size-7",onClick:()=>ee(s.product.id,-1),children:e.jsx(Be,{className:"size-3"})}),e.jsx("span",{className:"min-w-[2rem] text-center text-sm font-medium",children:s.quantity}),e.jsx(c,{variant:"outline",size:"icon",className:"size-7",onClick:()=>ee(s.product.id,1),disabled:s.quantity>=s.available_quantity,children:e.jsx(V,{className:"size-3"})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[n.length>0&&e.jsxs(B,{value:s.promotion_id??"none",onValueChange:a=>fe(s.product.id,a==="none"?null:a),children:[e.jsx(E,{className:"h-7 w-auto min-w-[80px] text-xs",children:e.jsx($,{placeholder:"Promo"})}),e.jsxs(O,{children:[e.jsx(f,{value:"none",children:"Sans promo"}),n.map(a=>e.jsxs(f,{value:a.id,children:[a.name," (",a.type==="percentage"?`${a.value}%`:`${Number(a.value).toLocaleString("fr-FR")} F`,")"]},a.id))]})]}),e.jsx(c,{variant:"ghost",size:"icon",className:"size-7 text-destructive",onClick:()=>pe(s.product.id),children:e.jsx(Ee,{className:"size-3"})})]})]})]},s.product.id)})})}),e.jsxs("div",{className:"border-t bg-muted/30 p-3",children:[e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Sous-total"}),e.jsxs("span",{children:[Y.toLocaleString("fr-FR")," F"]})]}),L>0&&e.jsxs("div",{className:"flex justify-between text-green-600",children:[e.jsx("span",{children:"Remises"}),e.jsxs("span",{children:["-",L.toLocaleString("fr-FR")," F"]})]}),e.jsx(K,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{className:"text-primary",children:[o.toLocaleString("fr-FR")," FCFA"]})]})]}),e.jsxs(c,{className:"mt-3 w-full",size:"lg",disabled:l.length===0,onClick:ve,children:[e.jsx(Re,{className:"size-5"}),"Encaisser ",o>0&&`${o.toLocaleString("fr-FR")} FCFA`]})]})]})]})]}),e.jsx(te,{open:ue,onOpenChange:C,children:e.jsxs(ae,{className:"max-w-lg",children:[e.jsxs(ne,{children:[e.jsx(re,{children:"Encaissement"}),e.jsxs(Pe,{children:["Total à payer : ",e.jsxs("strong",{children:[o.toLocaleString("fr-FR")," FCFA"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[x.map((s,t)=>e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(v,{className:"text-xs",children:"Mode"}),e.jsxs(B,{value:s.method,onValueChange:n=>k(t,"method",n),children:[e.jsx(E,{className:"h-9",children:e.jsx($,{})}),e.jsx(O,{children:ce.map(n=>e.jsx(f,{value:n.value,children:n.label},n.value))})]})]}),e.jsxs("div",{className:"w-32",children:[e.jsx(v,{className:"text-xs",children:"Montant"}),e.jsx(p,{type:"number",min:"0",className:"h-9",value:s.amount,onChange:n=>k(t,"amount",Number(n.target.value))})]}),s.method!=="cash"&&e.jsxs("div",{className:"w-28",children:[e.jsx(v,{className:"text-xs",children:"Réf."}),e.jsx(p,{className:"h-9",placeholder:"Réf.",value:s.reference,onChange:n=>k(t,"reference",n.target.value)})]}),x.length>1&&e.jsx(c,{variant:"ghost",size:"icon",className:"size-9 text-destructive",onClick:()=>ge(t),children:e.jsx(le,{className:"size-4"})})]},t)),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{variant:"outline",size:"sm",onClick:je,children:[e.jsx(V,{className:"size-3"})," Ajouter un mode"]}),e.jsx(c,{variant:"outline",size:"sm",onClick:Ne,children:"Tout en espèces"})]}),e.jsx(K,{}),x.some(s=>s.method==="cash")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Montant remis par le client (espèces)"}),e.jsx(p,{type:"number",min:"0",value:g,onChange:s=>T(Number(s.target.value))}),g>0&&g>o&&e.jsxs("div",{className:"rounded-lg bg-green-50 p-2 text-center dark:bg-green-950",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Monnaie à rendre"}),e.jsxs("p",{className:"text-xl font-bold text-green-600",children:[(g-o).toLocaleString("fr-FR")," FCFA"]})]})]}),D>0&&S&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Action sur la monnaie restante"}),e.jsxs(B,{value:P,onValueChange:xe,children:[e.jsx(E,{children:e.jsx($,{})}),e.jsxs(O,{children:[e.jsx(f,{value:"return",children:"Rendre la monnaie"}),e.jsx(f,{value:"keep_residue",children:"Conserver le résidu"}),e.jsx(f,{value:"credit_customer",children:"Créditer le compte client"})]})]})]}),e.jsxs("div",{className:"rounded-lg bg-muted p-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{className:"font-bold",children:[o.toLocaleString("fr-FR")," FCFA"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Payé"}),e.jsxs("span",{className:"font-medium",children:[z.toLocaleString("fr-FR")," FCFA"]})]}),A>0&&e.jsxs("div",{className:"flex justify-between text-orange-600",children:[e.jsx("span",{children:"Reste à payer (créance)"}),e.jsxs("span",{className:"font-bold",children:[A.toLocaleString("fr-FR")," FCFA"]})]}),D>0&&e.jsxs("div",{className:"flex justify-between text-green-600",children:[e.jsx("span",{children:"Monnaie"}),e.jsxs("span",{className:"font-bold",children:[D.toLocaleString("fr-FR")," FCFA"]})]})]})]}),e.jsxs(Le,{children:[e.jsx(c,{variant:"outline",onClick:()=>C(!1),children:"Annuler"}),e.jsx(c,{onClick:ye,disabled:H||z<=0&&!A,children:H?"Traitement…":"Valider la vente"})]})]})}),e.jsx(te,{open:me,onOpenChange:w,children:e.jsxs(ae,{className:"max-w-md",children:[e.jsx(ne,{children:e.jsx(re,{children:"Sélectionner ou créer un client"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"max-h-48 overflow-auto space-y-1",children:oe.map(s=>e.jsxs("button",{onClick:()=>{F(s),w(!1)},className:"flex w-full items-center justify-between rounded-lg border p-2 text-left hover:bg-muted",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:s.name}),s.phone&&e.jsx("p",{className:"text-xs text-muted-foreground",children:s.phone})]}),Number(s.credit_balance)!==0&&e.jsxs(u,{variant:Number(s.credit_balance)>0?"default":"destructive",children:[Number(s.credit_balance).toLocaleString("fr-FR")," F"]})]},s.id))}),e.jsx(K,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Nouveau client"}),e.jsx(p,{placeholder:"Nom",value:q,onChange:s=>G(s.target.value)}),e.jsx(p,{placeholder:"Téléphone",value:J,onChange:s=>Q(s.target.value)}),e.jsxs(c,{variant:"outline",className:"w-full",onClick:be,disabled:!q,children:[e.jsx(V,{className:"size-4"})," Créer le client"]})]})]})]})})]})}export{vs as default};
